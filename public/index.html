<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twitch Live Watch - Reklamsız İzle</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d0d0f;
      --surface: #16161a;
      --border: #2a2a2e;
      --text: #e4e4e7;
      --text-dim: #71717a;
      --accent: #a855f7;
      --accent-hover: #c084fc;
      --success: #22c55e;
      --error: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow: hidden;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .toolbar {
      padding: 12px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 12px;
      align-items: center;
      flex-shrink: 0;
    }

    .url-input-wrap {
      flex: 1;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .url-input {
      flex: 1;
      padding: 10px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      transition: border-color 0.2s;
    }

    .url-input::placeholder {
      color: var(--text-dim);
    }

    .url-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: #3f3f46;
    }

    .video-container {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      min-height: 0;
    }

    .video-container video {
      max-width: 100%;
      max-height: 100%;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      color: var(--text-dim);
      padding: 24px;
      text-align: center;
    }

    .placeholder.hidden {
      display: none;
    }

    .placeholder svg {
      width: 64px;
      height: 64px;
      opacity: 0.5;
    }

    .status {
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .status.loading {
      background: rgba(168, 85, 247, 0.15);
      color: var(--accent);
    }

    .status.error {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error);
    }

    .status.playing {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
    }

    .fullscreen-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      border-radius: 8px;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .fullscreen-btn:hover {
      opacity: 1;
    }

    .fullscreen-btn svg {
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="toolbar">
      <div class="url-input-wrap">
        <input
          type="text"
          id="urlInput"
          class="url-input"
          placeholder="Twitch yayın linki (örn: twitch.tv/kanaladi)"
        />
        <button id="playBtn" class="btn btn-primary">Oynat</button>
      </div>
      <button id="stopBtn" class="btn btn-secondary">Durdur</button>
    </div>

    <div class="video-container">
      <video id="video" controls autoplay muted playsinline></video>
      <div id="placeholder" class="placeholder">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        <p>Twitch yayın linkini girin veya m3u8 URL yapıştırın</p>
        <p style="font-size: 12px; max-width: 450px;">Twitch: twitch.tv/kanaladi (canlı yayın açık olmalı) — m3u8: F12 → Network’ten playlist URL’si</p>
      </div>
      <button id="fullscreenBtn" class="fullscreen-btn" title="Tam ekran" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
        </svg>
      </button>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const urlInput = document.getElementById('urlInput');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const placeholder = document.getElementById('placeholder');
    const fullscreenBtn = document.getElementById('fullscreenBtn');

    urlInput.value = localStorage.getItem('twitchChannelUrl') || '';

    let hls = null;

    function setStatus(message, type = 'loading') {
      const existing = placeholder.querySelector('.status');
      if (existing) existing.remove();
      const status = document.createElement('div');
      status.className = `status ${type}`;
      status.textContent = message;
      placeholder.appendChild(status);
    }

    function playStream(m3u8Url) {
      stopStream();

      const proxyUrl = `/api/proxy?url=${encodeURIComponent(m3u8Url)}`;
      placeholder.classList.remove('hidden');
      placeholder.innerHTML = '<p>Yükleniyor...</p>';
      setStatus('Akış bağlanıyor...', 'loading');
      fullscreenBtn.style.display = 'none';

      if (Hls.isSupported()) {
        hls = new Hls({
          enableWorker: true,
          lowLatencyMode: true,
          backBufferLength: 90,
          maxBufferLength: 30,
          maxMaxBufferLength: 60,
        });

        hls.loadSource(proxyUrl);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          setStatus('Oynatılıyor', 'playing');
          placeholder.classList.add('hidden');
          fullscreenBtn.style.display = 'flex';
          video.muted = false;
        });

        hls.on(Hls.Events.ERROR, (event, data) => {
          if (data.fatal) {
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                setStatus('Ağ hatası - URL geçersiz veya süresi dolmuş olabilir', 'error');
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                hls.recoverMediaError();
                break;
              default:
                setStatus('Oynatma hatası: ' + (data.details || 'Bilinmeyen'), 'error');
            }
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = proxyUrl;
        video.addEventListener('loadedmetadata', () => {
          setStatus('Oynatılıyor', 'playing');
          placeholder.classList.add('hidden');
          fullscreenBtn.style.display = 'flex';
          video.muted = false;
        });
      } else {
        setStatus('Tarayıcınız HLS desteklemiyor', 'error');
      }
    }

    function stopStream() {
      if (hls) {
        hls.destroy();
        hls = null;
      }
      video.src = '';
      video.load();
      placeholder.classList.remove('hidden');
      placeholder.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        <p>Twitch yayın linkini girin ve Oynat'a tıklayın</p>
      `;
      fullscreenBtn.style.display = 'none';
    }

    playBtn.addEventListener('click', async () => {
      const input = urlInput.value.trim();
      if (!input) {
        setStatus('Lütfen Twitch yayın linki veya m3u8 URL girin', 'error');
        return;
      }
      localStorage.setItem('twitchChannelUrl', input);
      
      placeholder.classList.remove('hidden');
      placeholder.innerHTML = '<p>Yükleniyor...</p>';
      playBtn.disabled = true;
      
      let m3u8Url = null;
      
      if (input.includes('.m3u8')) {
        m3u8Url = input;
        setStatus('m3u8 URL kullanılıyor...', 'loading');
      } else {
        setStatus('Stream URL alınıyor...', 'loading');
        try {
          const res = await fetch(`/api/resolve?url=${encodeURIComponent(input)}`);
          const data = await res.json();
          if (!res.ok) {
            setStatus(data.error || 'Hata oluştu', 'error');
            return;
          }
          m3u8Url = data.url;
        } catch (err) {
          setStatus('Sunucuya ulaşılamadı. npm start ile sunucuyu başlattınız mı?', 'error');
          return;
        } finally {
          playBtn.disabled = false;
        }
      }
      
      playStream(m3u8Url);
      playBtn.disabled = false;
    });

    stopBtn.addEventListener('click', stopStream);

    fullscreenBtn.addEventListener('click', () => {
      const container = document.querySelector('.video-container');
      if (!document.fullscreenElement) {
        container.requestFullscreen?.() || document.documentElement.requestFullscreen?.();
      } else {
        document.exitFullscreen?.();
      }
    });

    urlInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') playBtn.click();
    });
  </script>
</body>
</html>
